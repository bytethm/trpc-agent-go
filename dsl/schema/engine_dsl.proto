syntax = "proto3";

package engine_dsl;

// Engine DSL core types for the trpc-agent-go DSL engine.
// This file intentionally does NOT define any HTTP routes. It only captures the
// data model so that other services (e.g., HTTP layer, frontends) can define
// their own APIs or transports on top of a consistent schema.

// Workflow represents a complete workflow definition in the engine DSL.
message Workflow {
  string version = 1;            // Optional DSL version, e.g. "1.0".
  string name = 2;               // Workflow name (meta).
  string description = 3;        // Optional description (meta).

  repeated Node nodes = 4;       // Executable nodes.
  repeated Edge edges = 5;       // Direct edges.
  repeated ConditionalEdge conditional_edges = 6; // Conditional routing edges.

  string entry_point = 7;        // ID of starting node.

  map<string, Value> metadata = 8; // Optional workflow-level metadata.

  // Declarative workflow-level state variables. These describe the shape and
  // reducer behavior of global state that nodes may read/write.
  repeated StateVariable state_variables = 9;
}

// Node represents an executable node in the engine DSL.
// In the JSON Workflow DSL the engine fields are flattened so that
// node_type / config / description appear directly under the node. The
// EngineNode wrapper here is an engine-level structure used for internal
// usage and for non-JSON transports.
message Node {
  string id = 1;           // Unique node identifier.
  EngineNode engine = 2;   // Engine-level node definition.
}

// EngineNode contains execution semantics for a node.
message EngineNode {
  string label = 1;                      // Optional human-readable label (meta).
  string node_type = 2;                  // Component name in registry, e.g., "builtin.llmagent".
  string node_version = 3;               // Optional component version string.
  map<string, Value> config = 4;         // Component-specific configuration.
  // Inputs/outputs are an advanced engine-level feature for explicit I/O
  // mappings. They are not part of the public Workflow JSON schema and
  // typical workflows omit them.
  repeated NodeIO inputs = 5;            // Optional explicit input mapping (engine-only).
  repeated NodeIO outputs = 6;           // Optional explicit output mapping (engine-only).
  string description = 7;                // Optional description (meta).
}

// Edge represents a direct connection between two nodes.
message Edge {
  string id = 1;        // Optional edge identifier (meta).
  string source = 2;    // Source node ID or "__start__".
  string target = 3;    // Target node ID or "__end__".
  string label = 4;     // Optional label (meta).
}

// ConditionalEdge represents a conditional routing decision.
message ConditionalEdge {
  string id = 1;         // Optional identifier (meta).
  string from = 2;       // Source node ID where condition is evaluated.
  Condition condition = 3;
}

// Condition defines the routing logic for conditional edges.
message Condition {
  // Type selects the condition strategy:
  // - "builtin": structured rules over state (CaseCondition) evaluated in cases.
  // - "function": delegate routing to a function component.
  // - "tool_routing": LLM tool-calls routing (AddToolsConditionalEdges pattern).
  string type = 1;

  // Builtin cases (when type="builtin"). Evaluated in order; first match wins.
  repeated BuiltinCase cases = 2;

  // Function-based routing (when type="function").
  string function = 3;

  // Tool routing configuration (when type="tool_routing").
  string tools_node = 4;
  string fallback = 5;

  // Routes map condition results to target node IDs (for type="function").
  map<string, string> routes = 6;

  // Default route if no condition matches (builtin/function).
  string default_route = 7;
}

// BuiltinCase represents a single builtin branch evaluated in order.
message BuiltinCase {
  string name = 1;              // Optional case label (meta).
  CaseCondition condition = 2;
  string target = 3;            // Target node ID when condition matches.
}

// CaseCondition groups multiple rules with a logical operator for a single
// builtin case.
message CaseCondition {
  repeated ConditionRule conditions = 1;
  string logical_operator = 2; // "and" | "or", default "and".
}

// ConditionRule compares a variable from state against a value.
message ConditionRule {
  string variable = 1;   // E.g., "output_parsed.classification".
  string operator = 2;   // E.g., "==", ">", "<", "contains", etc.
  Value value = 3;       // Right-hand side value.
}

// NodeIO defines an input or output parameter mapping for a node.
// NOTE: NodeIO is an engine-level concept. The public Workflow JSON schema
// does not require editors to emit per-node NodeIO; instead, component I/O
// comes from ComponentMetadata (inputs/outputs) and internal inference.
message NodeIO {
  string name = 1;
  string type = 2;       // Historical Go type string (optional).
  string type_id = 3;    // DSL-level type identifier (optional).
  string kind = 4;       // "string" | "number" | "boolean" | "object" | "array" | "opaque".
  map<string, Value> json_schema = 5; // Optional JSON Schema for structured objects.
  bool required = 6;
  string description = 7;
  IOSource source = 8;   // Optional input source mapping.
  IOTarget target = 9;   // Optional output target mapping.
  Value default_value = 10;
  string reducer = 11;   // Optional reducer function name for outputs.
}

// IOSource specifies where to read input data from.
message IOSource {
  string type = 1;   // "state" | "node" | "constant".
  string field = 2;  // State field name (when type="state").
  string node = 3;   // Source node ID (when type="node").
  string output = 4; // Output parameter name from source node (when type="node").
  Value value = 5;   // Constant value (when type="constant").
}

// IOTarget specifies where to write output data to.
message IOTarget {
  string type = 1;   // "state" | "output".
  string field = 2;  // State field name (when type="state").
}

// ComponentMetadata describes a component's interface and capabilities.
message ComponentMetadata {
  string name = 1;
  string display_name = 2;
  string description = 3;
  string category = 4;
  string version = 5;
  repeated ParameterSchema inputs = 6;
  repeated ParameterSchema outputs = 7;
  repeated ParameterSchema config_schema = 8;
  // Optional engine-agnostic metadata for higher layers (e.g., editors).
  map<string, Value> meta = 9;
}

// ParameterSchema defines the schema for an input, output, or config parameter.
message ParameterSchema {
  string name = 1;
  string display_name = 2;
  string description = 3;
  string type = 4;        // Go type string, e.g., "string", "int", "[]model.Message".
  string type_id = 5;     // Logical DSL type identifier, e.g., "string", "graph.messages".
  string kind = 6;        // "string" | "number" | "boolean" | "object" | "array" | "opaque".
  bool required = 7;
  Value default_value = 8;
  repeated Value enum_values = 9;
  string placeholder = 10;
  ValidationRules validation = 11;
  map<string, Value> json_schema = 12; // Optional JSON Schema when structured.
}

// ValidationRules defines validation constraints for a parameter.
message ValidationRules {
  double min = 1;
  double max = 2;
  string pattern = 3;
}

// Value is a simple tagged union to represent arbitrary JSON values.
message Value {
  oneof kind {
    string string_value = 1;
    double number_value = 2;
    bool bool_value = 3;
    ListValue list_value = 4;
    StructValue struct_value = 5;
    NullValue null_value = 6;
  }
}

message ListValue {
  repeated Value values = 1;
}

message StructValue {
  map<string, Value> fields = 1;
}

enum NullValue {
  NULL_VALUE_UNSPECIFIED = 0;
}

// StateVariable describes a workflow-level state variable.
message StateVariable {
  string name = 1;         // State field name, e.g., "greeting".
  string kind = 2;         // "string" | "number" | "boolean" | "object" | "array" | "opaque".
  map<string, Value> json_schema = 3; // Optional JSON Schema when structured.
  Value default_value = 4; // Optional default value.
  string description = 5;  // Optional description (meta).
  string reducer = 6;      // Optional reducer function name; empty => default.
}
